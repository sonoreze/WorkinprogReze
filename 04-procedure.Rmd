# Procédure

La procédure consiste à :

  * créer un identifiant par trace (suite d'enregistrements successifs) ;
  * ne garder qu'un enregistrement par trace ;
  * supprimer les traces qui n'ont pas été taggées, ainsi que celles sans coordonnées GPS :
  
```{r}
tags_table[1:10,]
```
  
  * à partir de la colonne « tags », qui contient pour chaque trace (chaque ligne) un ou plusieurs tags séparés par des virgules : créer une nouvelle colonne « tags » avec un seul tag (par ligne), quitte à dupliquer une trace (une ligne) lorsque cette-dernière a plusieurs tags :
  
```{r}
tags_table <- tags_table %>%
      transform(tags = strsplit(as.character(tags),",")) %>%
      unnest(tags) %>%
      mutate(TagGroup = case_when(tags == "indoor" | tags == "test" ~ "Condition",
                                  tags == "wind" | tags == "rain" ~ "Meteo",
                                  tags == "marine_traffic" | tags == "air_traffic" | tags == "rail" | tags == "road" ~ "Trafic",
                                  TRUE ~ "Ambiance"))
```

Voici les effectifs par tags :

```{r}
summary(as.factor(tags_table$tags))
```

Quatre catégories ont été définies :

  * Météo : *rain* / *wind*
  * Condition : *indoor* / *test*
  * Trafic : *road* / *marine_traffic* / *air_traffic* / *rail*
  * Ambiance : *chatting* / *footsteps* / *water* / *animals* / *vegetation* / *works* / *children* / *music* / *alarms* / *industrial*
  
Voici les effectifs par catégorie :
```{r,warning=FALSE}
ggplot(tags_table, aes(x=TagGroup)) +
        geom_histogram(stat="count")
```

```{r}
Data_numerique <- tags_table[,c("x","y","TagGroup")]
pal <- colorFactor(viridis(7), Data_numerique$TagGroup)

leaflet(Data_numerique) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(lng = ~x, 
                   lat = ~y, 
                   radius = 1.5, 
                   color = pal(Data_numerique$TagGroup),
                   stroke=FALSE,
                   fillOpacity = 0.8,
                   popup = ~TagGroup) %>%
  addLegend("bottomleft",
            pal = pal,
            values = Data_numerique$TagGroup,
            na.label = "NA",
            title = "Catégories",
            #labels = pal2,
            opacity = .8,
            )
```